name: ðŸš€ Migration Base de DonnÃ©es Supabase

on:
  workflow_dispatch: # DÃ©clencher manuellement
    inputs:
      confirm:
        description: 'Tapez "MIGRATE" pour confirmer'
        required: true
        type: string
      migrate_storage:
        description: 'Migrer le storage (buckets et politiques)'
        required: false
        type: boolean
        default: true
      migrate_auth:
        description: 'Migrer les configurations auth'
        required: false
        type: boolean
        default: true

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
      DEV_TEST_DATABASE_URL: ${{ secrets.DEV_TEST_DATABASE_URL }}
      SOURCE_SUPABASE_URL: ${{ secrets.SOURCE_SUPABASE_URL }}
      SOURCE_SUPABASE_SERVICE_KEY: ${{ secrets.SOURCE_SUPABASE_SERVICE_KEY }}
      TARGET_SUPABASE_URL: ${{ secrets.TARGET_SUPABASE_URL }}
      TARGET_SUPABASE_SERVICE_KEY: ${{ secrets.TARGET_SUPABASE_SERVICE_KEY }}
    
    steps:
    - name: ðŸ›¡ï¸ VÃ©rification de confirmation
      if: github.event.inputs.confirm != 'MIGRATE'
      run: |
        echo "âŒ Vous devez taper 'MIGRATE' pour confirmer"
        exit 1
        
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ðŸ˜ Installation PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: ðŸ“¦ Installation Node.js et Supabase CLI
      if: github.event.inputs.migrate_storage == 'true' || github.event.inputs.migrate_auth == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ðŸ”§ Installation Supabase CLI
      if: github.event.inputs.migrate_storage == 'true' || github.event.inputs.migrate_auth == 'true'
      run: |
        npm install -g @supabase/supabase-js
        curl -fsSL https://supabase.com/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: ðŸ”§ Permissions des scripts
      run: |
        chmod +x scripts/migrate.sh
        chmod +x scripts/verify.sh
        
    - name: ðŸš€ Migration des donnÃ©es (Tables) - TEMPORAIREMENT DÃ‰SACTIVÃ‰
      if: false  # DÃ©sactive cette Ã©tape
      env:
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        DEV_TEST_DATABASE_URL: ${{ secrets.DEV_TEST_DATABASE_URL }}
      run: ./scripts/migrate.sh
      
    - name: â„¹ï¸ Skip Migration Tables
      run: |
        echo "â­ï¸ Migration des tables ignorÃ©e pour ce test"
        echo "ðŸŽ¯ Focus sur Storage et Auth seulement"
      
    - name: ðŸ—‚ï¸ Migration Storage (Buckets et Politiques)
      if: github.event.inputs.migrate_storage == 'true'
      run: |
        echo "ðŸ—‚ï¸ Migration du storage..."
        
        # CrÃ©er le script de migration storage
        cat > migrate_storage.sql << 'EOF'
        -- Migrer les buckets depuis le projet source
        INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types, avif_autodetection, created_at, updated_at)
        SELECT id, name, public, file_size_limit, allowed_mime_types, avif_autodetection, created_at, updated_at
        FROM storage.buckets
        ON CONFLICT (id) DO UPDATE SET
          name = EXCLUDED.name,
          public = EXCLUDED.public,
          file_size_limit = EXCLUDED.file_size_limit,
          allowed_mime_types = EXCLUDED.allowed_mime_types,
          avif_autodetection = EXCLUDED.avif_autodetection,
          updated_at = EXCLUDED.updated_at;
        EOF
        
        # Exporter les buckets depuis la source
        echo "ðŸ“¤ Export des buckets depuis la source..."
        psql "$DEV_DATABASE_URL" -c "SELECT 'Buckets trouvÃ©s:', COUNT(*) FROM storage.buckets;"
        
        # CrÃ©er un dump spÃ©cifique pour le storage
        pg_dump "$DEV_DATABASE_URL" \
          --verbose \
          --no-owner \
          --no-privileges \
          --data-only \
          --table=storage.buckets \
          --table=storage.objects > storage_backup.sql
        
        # Importer dans la destination
        echo "ðŸ“¥ Import des buckets vers la destination..."
        psql "$DEV_TEST_DATABASE_URL" < storage_backup.sql
        
        # VÃ©rification
        psql "$DEV_TEST_DATABASE_URL" -c "SELECT 'Buckets migrÃ©s:', COUNT(*) FROM storage.buckets;"
        
        rm storage_backup.sql
        echo "âœ… Migration storage terminÃ©e"
        
    - name: ðŸ” Migration Auth (Configurations)
      if: github.event.inputs.migrate_auth == 'true'
      run: |
        echo "ðŸ” Migration des configurations auth..."
        
        # CrÃ©er le script pour migrer les configurations auth
        cat > migrate_auth.sql << 'EOF'
        -- Migrer les configurations auth si elles existent dans des tables personnalisÃ©es
        -- Note: Les utilisateurs Supabase sont dans auth.users (schÃ©ma protÃ©gÃ©)
        
        -- Exemple pour migrer des mÃ©tadonnÃ©es utilisateur personnalisÃ©es
        -- INSERT INTO user_profiles (user_id, display_name, avatar_url, created_at)
        -- SELECT user_id, display_name, avatar_url, created_at FROM user_profiles
        -- ON CONFLICT (user_id) DO UPDATE SET
        --   display_name = EXCLUDED.display_name,
        --   avatar_url = EXCLUDED.avatar_url;
        
        -- VÃ©rifier les tables liÃ©es Ã  l'auth
        SELECT 'Tables auth trouvÃ©es:', COUNT(*) 
        FROM information_schema.tables 
        WHERE table_name LIKE '%user%' OR table_name LIKE '%auth%' 
        AND table_schema = 'public';
        EOF
        
        # Exporter les donnÃ©es auth personnalisÃ©es (profiles, etc.)
        echo "ðŸ“¤ Export des donnÃ©es auth personnalisÃ©es..."
        pg_dump "$DEV_DATABASE_URL" \
          --verbose \
          --no-owner \
          --no-privileges \
          --data-only \
          --table="*user*" \
          --table="*profile*" > auth_backup.sql 2>/dev/null || echo "Aucune table auth personnalisÃ©e trouvÃ©e"
        
        # Importer si le fichier n'est pas vide
        if [ -s auth_backup.sql ]; then
          echo "ðŸ“¥ Import des donnÃ©es auth personnalisÃ©es..."
          psql "$DEV_TEST_DATABASE_URL" < auth_backup.sql
        else
          echo "â„¹ï¸ Aucune donnÃ©e auth personnalisÃ©e Ã  migrer"
        fi
        
        # Appliquer les configurations
        psql "$DEV_TEST_DATABASE_URL" < migrate_auth.sql
        
        rm -f auth_backup.sql migrate_auth.sql
        echo "âœ… Migration auth terminÃ©e"
        
    - name: ðŸ” VÃ©rification post-migration
      env:
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        DEV_TEST_DATABASE_URL: ${{ secrets.DEV_TEST_DATABASE_URL }}
      run: |
        # ./scripts/verify.sh  # DÃ©sactivÃ© temporairement
        echo "â­ï¸ VÃ©rification tables ignorÃ©e pour ce test"
        
        # VÃ©rifications supplÃ©mentaires pour storage et auth
        if [ "${{ github.event.inputs.migrate_storage }}" = "true" ]; then
          echo "ðŸ—‚ï¸ VÃ©rification Storage:"
          psql "$DEV_TEST_DATABASE_URL" -c "SELECT 'Buckets:', COUNT(*) FROM storage.buckets;"
          psql "$DEV_TEST_DATABASE_URL" -c "SELECT id, name, public FROM storage.buckets;"
        fi
        
        if [ "${{ github.event.inputs.migrate_auth }}" = "true" ]; then
          echo "ðŸ” VÃ©rification Auth:"
          psql "$DEV_TEST_DATABASE_URL" -c "SELECT 'Tables auth:', COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND (table_name LIKE '%user%' OR table_name LIKE '%profile%');"
        fi
        
    - name: ðŸŽ‰ Notification de succÃ¨s
      run: |
        echo "ðŸŽŠ Migration terminÃ©e avec succÃ¨s !"
        echo "ðŸ“Š VÃ©rifiez votre base DEV-HDS dans le dashboard Supabase"
        if [ "${{ github.event.inputs.migrate_storage }}" = "true" ]; then
          echo "ðŸ—‚ï¸ Storage migrÃ© - VÃ©rifiez vos buckets dans le dashboard"
        fi
        if [ "${{ github.event.inputs.migrate_auth }}" = "true" ]; then
          echo "ðŸ” Configurations auth migrÃ©es"
        fi