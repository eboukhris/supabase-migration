name: ğŸš€ Migration Base de DonnÃ©es Supabase

on:
  workflow_dispatch:  # DÃ©clencher manuellement
    inputs:
      confirm:
        description: 'Tapez "MIGRATE" pour confirmer'
        required: true
        type: string

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
      DEV_TEST_DATABASE_URL: ${{ secrets.DEV_TEST_DATABASE_URL }} # ou une valeur vide si pas utilisÃ©e
    steps:
    - name: ğŸ›¡ï¸ VÃ©rification de confirmation
      if: github.event.inputs.confirm != 'MIGRATE'
      run: |
        echo "âŒ Vous devez taper 'MIGRATE' pour confirmer"
        exit 1
    
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ˜ Installation PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
    
    - name: ğŸ”§ Permissions des scripts
      run: |
        chmod +x scripts/migrate.sh
        chmod +x scripts/verify.sh
    
    - name: ğŸš€ Migration des donnÃ©es
      env:
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        DEV_TEST_DATABASE_URL: ${{ secrets.DEV_TEST_DATABASE_URL }}
      run: ./scripts/migrate.sh
    
    - name: ğŸ” VÃ©rification post-migration
      env:
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        DEV_TEST_DATABASE_URL: ${{ secrets.DEV_TEST_DATABASE_URL }}
      run: ./scripts/verify.sh
    
    - name: ğŸ‰ Notification de succÃ¨s
      run: |
        echo "ğŸŠ Migration terminÃ©e avec succÃ¨s !"
        echo "ğŸ“Š VÃ©rifiez votre base DEV-HDS dans le dashboard Supabase"